# Solana DEX Trading Bot - Project Structure

## ğŸ“ Project Overview

```
Eterna/
â”œâ”€â”€ src/                          # Source code (TypeScript)
â”‚   â”œâ”€â”€ config/                   # Configuration management
â”‚   â”‚   â””â”€â”€ index.ts             # Environment variables & settings
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                       # Database layer
â”‚   â”‚   â”œâ”€â”€ schema.ts            # PostgreSQL schema & initialization
â”‚   â”‚   â”œâ”€â”€ repository.ts        # Data access layer (CRUD operations)
â”‚   â”‚   â””â”€â”€ redis.ts             # Redis cache & rate limiting
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                   # HTTP & WebSocket endpoints
â”‚   â”‚   â””â”€â”€ index.ts             # API routes (POST /api/orders, WS /ws/orders/:id)
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                 # Business logic & external integrations
â”‚   â”‚   â”œâ”€â”€ raydium.ts           # Raydium DEX router
â”‚   â”‚   â”œâ”€â”€ meteora.ts           # Meteora DEX router
â”‚   â”‚   â””â”€â”€ dex-aggregator.ts    # DEX comparison & best price selection
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                    # TypeScript type definitions
â”‚   â”‚   â””â”€â”€ index.ts             # Interfaces, enums, types
â”‚   â”‚
â”‚   â”œâ”€â”€ workers/                  # Background job processing
â”‚   â”‚   â””â”€â”€ order-processor.ts   # BullMQ worker for order execution
â”‚   â”‚
â”‚   â””â”€â”€ index.ts                  # Main entry point (server startup)
â”‚
â”œâ”€â”€ dist/                         # Compiled JavaScript (generated by tsc)
â”‚   â””â”€â”€ [mirrors src/ structure]
â”‚
â”œâ”€â”€ node_modules/                 # Dependencies (npm install)
â”‚   â””â”€â”€ [554 packages installed]
â”‚
â”œâ”€â”€ .env.example                  # Environment variable template
â”œâ”€â”€ .gitignore                    # Git ignore rules
â”œâ”€â”€ package.json                  # Project metadata & dependencies
â”œâ”€â”€ package-lock.json             # Locked dependency versions
â”œâ”€â”€ tsconfig.json                 # TypeScript compiler configuration
â”‚
â”œâ”€â”€ README.md                     # Main project documentation
â”œâ”€â”€ IMPLEMENTATION_GUIDE.md       # Real SDK integration guide
â””â”€â”€ REQUIREMENTS_CHECKLIST.md     # Requirements verification
```

---

## ğŸ“Š Statistics

| Category | Count | Lines |
|----------|-------|-------|
| **Source Files** | 11 | 1,665 |
| **TypeScript Config** | 1 | 25 |
| **Environment Files** | 1 | 30 |
| **Documentation** | 3 | 1,130 |
| **Dependencies** | 554 packages | - |
| **Total Project Size** | - | ~2,850 lines |

---

## ğŸ—‚ï¸ File Descriptions

### Configuration

| File | Purpose | Key Contents |
|------|---------|--------------|
| `tsconfig.json` | TypeScript compiler settings | Target: ES2022, Module: Node16, Strict mode |
| `package.json` | Project metadata & scripts | 12 dependencies, 10 devDependencies |
| `.env.example` | Environment variable template | DB connection, Redis, Solana RPC, secrets |

### Source Code (`src/`)

#### Core Application

| File | Lines | Purpose | Key Exports |
|------|-------|---------|-------------|
| `index.ts` | 85 | Server entry point | Fastify app initialization, graceful shutdown |
| `config/index.ts` | 80 | Centralized config | Server, Solana, PostgreSQL, Redis, Queue settings |
| `types/index.ts` | 150 | Type definitions | OrderType, OrderStatus, Order, DEXQuote, WSMessage |

#### Database Layer (`src/db/`)

| File | Lines | Purpose | Key Functions |
|------|-------|---------|---------------|
| `schema.ts` | 120 | PostgreSQL schema | `initDatabase()`, table definitions, indexes |
| `repository.ts` | 190 | Data access layer | `createOrder()`, `updateOrderStatus()`, `saveRoutingDecision()` |
| `redis.ts` | 130 | Redis operations | `setOrder()`, `getOrder()`, `isRateLimited()`, `publishOrderUpdate()` |

**Database Schema**:
- **orders**: 17 columns (id, user_id, order_type, status, input/output tokens, amounts, slippage, limit_price, transaction_id, selected_dex, error_message, timestamps)
- **routing_decisions**: 8 columns (id, order_id, selected_dex, raydium_quote, meteora_quote, reason, created_at)
- **retry_logs**: 5 columns (id, order_id, attempt_number, error_message, created_at)

#### API Layer (`src/routes/`)

| File | Lines | Purpose | Endpoints |
|------|-------|---------|-----------|
| `index.ts` | 290 | REST + WebSocket | POST /api/orders, GET /api/orders/:id, WS /ws/orders/:id, GET /health |

**HTTP Endpoints**:
- `POST /api/orders`: Create new order â†’ Returns orderId
- `GET /api/orders/:id`: Get order status
- `GET /health`: Health check

**WebSocket Endpoint**:
- `GET /ws/orders/:id`: Subscribe to real-time order updates

#### Services Layer (`src/services/`)

| File | Lines | Purpose | Key Methods |
|------|-------|---------|-------------|
| `raydium.ts` | 120 | Raydium DEX integration | `getQuote()`, `executeSwap()`, `isPairSupported()` |
| `meteora.ts` | 120 | Meteora DEX integration | `getQuote()`, `executeSwap()`, `isPairSupported()` |
| `dex-aggregator.ts` | 160 | DEX comparison logic | `getBestQuote()`, `executeSwap()`, `selectBestQuote()` |

**DEX Router Features**:
- Parallel quote fetching (2-3s latency simulation)
- Fee calculations (Raydium: 0.3%, Meteora: 0.2%)
- Price impact simulation (0.3-0.5%)
- Slippage tolerance handling
- Transaction execution with confirmation

**Aggregator Logic**:
1. Fetch quotes from both DEXes in parallel
2. Compare output amounts (primary)
3. Compare price impacts (secondary)
4. Log routing decision to database
5. Execute on selected DEX

#### Workers Layer (`src/workers/`)

| File | Lines | Purpose | Key Features |
|------|-------|---------|--------------|
| `order-processor.ts` | 220 | BullMQ order processing | Concurrent workers, retry logic, WebSocket broadcasting |

**Worker Features**:
- 10 concurrent workers (configurable)
- 100 orders/min rate limit
- Exponential backoff retry (3 attempts: 1s â†’ 2s â†’ 4s)
- Status broadcasting via Redis pub/sub
- Comprehensive error handling

**Order Processing Flow**:
```
1. PENDING     â†’ Worker picks up from queue
2. PROCESSING  â†’ Fetch quotes from Raydium & Meteora
3. ROUTING     â†’ Compare quotes, select best DEX
4. EXECUTING   â†’ Execute swap transaction
5. COMPLETED   â†’ Success, broadcast final status
   OR FAILED   â†’ Retry with exponential backoff (3x max)
```

---

## ğŸ“¦ Dependencies

### Production Dependencies (12)

| Package | Version | Purpose |
|---------|---------|---------|
| `fastify` | ^4.26.2 | Web framework (REST + WebSocket) |
| `@fastify/websocket` | ^10.0.1 | WebSocket support |
| `@solana/web3.js` | ^1.91.1 | Solana blockchain integration |
| `@solana/spl-token` | ^0.3.9 | SPL token operations |
| `bullmq` | ^5.4.0 | Redis-based job queue |
| `ioredis` | ^5.3.2 | Redis client |
| `pg` | ^8.7.3 | PostgreSQL client |
| `pino` | ^8.19.0 | High-performance logger |
| `pino-pretty` | ^11.0.0 | Pretty-print logs (dev) |
| `dotenv` | ^16.4.5 | Environment variables |
| `bn.js` | ^5.2.1 | Big number arithmetic |
| `decimal.js` | ^10.4.3 | Decimal math (precision) |
| `uuid` | ^9.0.1 | UUID generation |

### Development Dependencies (10)

| Package | Version | Purpose |
|---------|---------|---------|
| `typescript` | ^5.4.3 | TypeScript compiler |
| `tsx` | ^4.7.1 | TypeScript execution (dev mode) |
| `@types/node` | ^20.11.30 | Node.js type definitions |
| `@types/pg` | ^8.11.4 | PostgreSQL type definitions |
| `@types/bn.js` | ^5.1.5 | bn.js type definitions |
| `@types/uuid` | ^9.0.8 | UUID type definitions |
| `@typescript-eslint/eslint-plugin` | ^7.3.1 | TypeScript linting |
| `@typescript-eslint/parser` | ^7.3.1 | TypeScript parser for ESLint |
| `eslint` | ^8.57.0 | JavaScript/TypeScript linter |
| `jest` | ^29.7.0 | Testing framework |

**Note**: Raydium and Meteora SDK packages are listed in `package.json` but currently using mock implementations. See `IMPLEMENTATION_GUIDE.md` for real SDK integration steps.

---

## ğŸš€ NPM Scripts

| Command | Purpose | Usage |
|---------|---------|-------|
| `npm run dev` | Development mode with hot reload | `tsx watch src/index.ts` |
| `npm run build` | Compile TypeScript to JavaScript | `tsc` |
| `npm start` | Start production server | `node dist/index.js` |
| `npm test` | Run Jest tests | `jest` |
| `npm run lint` | Lint TypeScript files | `eslint src/**/*.ts` |

---

## ğŸ”§ Configuration Files

### TypeScript Config (`tsconfig.json`)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "Node16",
    "moduleResolution": "Node16",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "types": ["node"]
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.spec.ts"]
}
```

**Key Settings**:
- Modern JavaScript (ES2022)
- Node.js module resolution
- Strict type checking enabled
- Source maps for debugging
- Declaration files for library usage

### Environment Variables (`.env.example`)

```bash
# Server Configuration
PORT=3000
HOST=0.0.0.0
NODE_ENV=development

# Solana Configuration
SOLANA_RPC_URL=https://api.devnet.solana.com
SOLANA_WS_URL=wss://api.devnet.solana.com
SOLANA_NETWORK=devnet

# PostgreSQL Configuration
DATABASE_URL=postgresql://localhost:5432/solana_dex_bot
DB_HOST=localhost
DB_PORT=5432
DB_NAME=solana_dex_bot
DB_USER=postgres
DB_PASSWORD=your_password

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Queue Configuration
QUEUE_CONCURRENCY=10
QUEUE_MAX_RETRIES=3
QUEUE_RATE_LIMIT_MAX=100
QUEUE_RATE_LIMIT_DURATION=60000

# Wallet Configuration (for DEX swaps)
WALLET_PRIVATE_KEY=your_base58_encoded_private_key_here
```

---

## ğŸ“ Documentation Files

| File | Lines | Purpose |
|------|-------|---------|
| `README.md` | 450 | Complete project documentation, API examples, testing guide |
| `IMPLEMENTATION_GUIDE.md` | 580 | Real Raydium/Meteora SDK integration steps |
| `REQUIREMENTS_CHECKLIST.md` | 100 | Verification of all core requirements |

---

## ğŸ§ª Testing

### Manual Testing

```bash
# 1. Start dependencies
redis-server
# (PostgreSQL should be running)

# 2. Create database
createdb solana_dex_bot

# 3. Start server
npm run dev

# 4. Test HTTP endpoint
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test_user_1",
    "orderType": "MARKET",
    "inputToken": "SOL",
    "outputToken": "USDC",
    "inputAmount": "1000000",
    "slippage": 0.01
  }'

# 5. Test WebSocket (using wscat)
npm install -g wscat
wscat -c ws://localhost:3000/ws/orders/<orderId>
```

### Database Queries

```sql
-- Check order status
SELECT * FROM orders WHERE id = 'order_id_here';

-- View routing decisions
SELECT * FROM routing_decisions WHERE order_id = 'order_id_here';

-- Check retry history
SELECT * FROM retry_logs WHERE order_id = 'order_id_here';

-- Statistics
SELECT status, COUNT(*) FROM orders GROUP BY status;
SELECT selected_dex, COUNT(*) FROM routing_decisions GROUP BY selected_dex;
```

---

## ğŸ” Security Considerations

- **Private Keys**: Never commit `.env` file with real private keys
- **Database**: Use strong passwords, restrict network access
- **Redis**: Enable password authentication in production
- **Rate Limiting**: Implement per-user limits to prevent abuse
- **Input Validation**: All API inputs are validated before processing
- **Error Handling**: Sensitive errors not exposed to clients

---

## ğŸš§ Current Status

âœ… **Complete**:
- Full project scaffolding
- All type definitions
- Database schema and repositories
- DEX routers (mock implementations)
- Order processing worker
- HTTP + WebSocket API
- Rate limiting and retry logic
- Comprehensive documentation

â³ **In Progress**:
- Real Raydium SDK integration (see IMPLEMENTATION_GUIDE.md)
- Real Meteora SDK integration (see IMPLEMENTATION_GUIDE.md)

ğŸ”œ **Future Enhancements**:
- Admin dashboard for monitoring
- Advanced order types (TWAP, VWAP)
- Multi-DEX support (Orca, Jupiter)
- Performance metrics and alerting
- Automated testing suite

---

## ğŸ“š Next Steps

1. **Run Development Server**: `npm run dev`
2. **Test with Mock Data**: Use cURL or Postman
3. **Review Implementation Guide**: For real SDK integration
4. **Check Requirements**: Verify all features in REQUIREMENTS_CHECKLIST.md
5. **Deploy to Devnet**: Follow IMPLEMENTATION_GUIDE.md steps

---

**Last Updated**: November 20, 2025
**Version**: 1.0.0
**Status**: Ready for Testing âœ…
